os: linux
dist: xenial

language: node_js

node_js:
  - "12"

python:
  - "3.6"

addons:
  # https://stackoverflow.com/questions/57903415/travis-ci-chrome-62-instead-of-77
  chrome: stable
  firefox: "67.0"

branches:
  only:
    - master

cache:
  npm: false
  yarn: false

notifications:
  email: false
  slack:
    rooms:
      - $SLACK_NOTIFICATION_TOKEN#distribution-alerts
    on_pull_requests: true

env:
  VERSION: "$TRAVIS_BUILD_NUMBER"
  global:
    - secure: AP2aO8rXupnh+KGs2xV+xZ4Jp99P4itSXIZEwSv9l4mlHx8XzSwwocPf00N1h32wR3efpuMpqwLFFM+Y8wuaK/JwAEgqHH87rD9hofvNAdKx3ml8mVOziAOoxC5ruPR/rmjSReCAFzQsz9844h7+tNPdeu/gQFmKV7pghcO6Lw45RFU2Qh3ixw/lmjr//vi40KAG3TTq5E5mSxNiJeTfReVDzD8FfIkKoEZuPQ+1j0i+4wLDHfYHmE8FwBM+TdmhmyS/N8xUEcMZhS76Y2vixkGtwbstRp4E+V1F0VCZgsx3MYXApjK/w2h5yav+XYBq5H7E9TTt+Nlr4rLaXihaILkPV8N92VpON4SqxYaYhWhwBhD4IKnEUJohgvJBQmXHlZt5msv/3hBfWoWAGV/qgNOxG8yDCIfCEvVBitTy1nV+fia0rFgz7f8uYHWnF0Z9w29Uae5xjx4h7Fa6S0JZ1/zYmcvS8apciXpaUhG2WWQNDsZw52OoBFkoYEgLurniibaUtYIscuzWcWIqf3rr4CtBZG5Zhxof1vCqkPq5ARqz4JTFUVMizsMHchzJnUAhGyCjZNF7C5ffBYlnyvroikp5ibHQj5SH4rG/r3zDYt8kFnUFQjygrbDFxZmOD1wdfSdAQ5k7Fj7wuJo6WLSwaqhFEF1WcLgvFSSC2BSSQMI=


before_install:
  - export APPLITOOLS_BATCH_ID=`echo ${TRAVIS_PULL_REQUEST_SHA:=$TRAVIS_COMMIT}`
  - export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY
  - export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_KEY
  - npm config set '//registry.npmjs.org/:_authToken' $NPM_TOKEN
  - npm config set '//npm.pkg.github.com/:_authToken' $GH_TOKEN
  - npm config set @typeform:registry https://npm.pkg.github.com/

jobs:
  include:
    - stage: "Test"
      name: "Lint"
      if: branch = master
      script:
        - yarn lint
    - name: "Unit Tests"
      if: branch = master
      script:
        - yarn test:unit
    - name: "Functional Tests Chrome (Internal)"
      if: fork = false AND branch = master
      script:
        - yarn serve-demo & export EMBED_PID=$!
        - yarn test:functional:chrome  --record --parallel --group functional-chrome
        - kill $EMBED_PID
    - name: "Functional Tests Firefox (Internal)"
      if: fork = false AND branch = master
      script:
        - yarn serve-demo & export EMBED_PID=$!
        - yarn test:functional:firefox --record --parallel --group functional-firefox
        - kill $EMBED_PID
    - name: "Functional Tests (External)"
      if: fork = true AND branch = master
      script:
        - yarn serve-demo & export EMBED_PID=$!
        - yarn test:functional:chrome --record false
        - yarn test:functional:firefox --record false
        - kill $EMBED_PID
    - name: "Visual Tests Chrome (Internal)"
      if: fork = false AND branch = master
      script:
        - yarn serve-demo & export EMBED_PID=$!
        - yarn test:visual:chrome  --record --parallel --group visual-chrome
        - kill $EMBED_PID
    - name: "Visual Tests Firefox (Internal)"
      if: fork = false AND branch = master
      script:
        - yarn serve-demo & export EMBED_PID=$!
        - yarn test:visual:firefox --record --parallel --group visual-firefox
        - kill $EMBED_PID
    - stage: "Release"
      name: "Deploy Preview to AWS"
      # Deploy to preview preview URL for testing purposes. Only deploy pull requests to 'master' branch.
      if: (type = pull_request AND branch = master AND fork = false) OR (type = push AND branch =~ /preview-./)
      script:
        - yarn build
        - pip install --user awscli
        - yarn add @typeform/jarvis
        - ./scripts/consolidate-dist.sh
        - DEBUG=jarvis yarn run jarvis deploy --path dist --preview --notify-preview
    - name: "Release to NPM"
      if: branch = master AND type = push
      script:
        - yarn semantic-release
    - name: "Release to AWS"
      if: branch = master AND type = push
      script:
        - yarn build
        - pip install --user awscli
        - yarn add @typeform/jarvis
        - ./scripts/consolidate-dist.sh
        - DEBUG=jarvis jarvis deploy --path dist
